@page "/ProductDetail/{ProductId:int}"
@inject Interfaces.IProduct ProductRepo
@inject Interfaces.ICategory CatRepo
@inject IJSRuntime JS
@inject NavigationManager Navigation

@if (product == null)
{
    <p>Loading...</p>
}
else
{
    <section class="product-details spad">
        <div class="container mb-3">
            <button class="btn btn-secondary mb-4" @onclick="GoBack">← Back to Products</button>
        </div>
        <div class="container mb-5">
            <div class="row">
           

                <div class="col-lg-12">
                    <div class="product__details__text">
                        <div class="product__label">@product.Category?.Name</div>
                        <h4>@product.Name</h4>

                        <h5>Prices</h5>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Flavour / Size</th>
                                    @foreach (var size in productSizes)
                                    {
                                        
                                        @if (size.CategoryId == 1)
                                        {
                                            <th>@($"{size.Size}\"")</th>
                                        }
                                        else if (size.CategoryId == 2)
                                        {
                                            <th>@($"{size.Size} peoples")</th>
                                        }
                                        else
                                        {
                                            <th>@($"{size.Size}")</th>
                                        }

                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var flavour in flavours)
                                {
                                    <tr>
                                        <td>@flavour.Name</td>
                                        @foreach (var size in productSizes)
                                        {
                                            var price = product.ProductPrices
                                            .FirstOrDefault(pp => pp.ProductSizeId == size.ProductSizeId && pp.FlavourId == flavour.FlavourId)
                                            ?.UnitPrice ?? 0;
                                            <td>@price.ToString("N0") MMK</td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>

                       
                    </div>
                </div>
            </div>
        </div>
    </section>
}

@code {
    [Parameter]
    public int ProductId { get; set; }

    private Product product;
    private Category category;
    private List<ProductSize> productSizes = new();
    private List<Flavour> flavours = new();

    protected override async Task OnInitializedAsync()
    {

        var  tempproductSizes = await ProductRepo.GetProductSizes();
        
        product = await ProductRepo.GetProductById(ProductId);
        category = await CatRepo.GetCategorybyId(product.CategoryId);
        productSizes =tempproductSizes.Where(x => x.CategoryId == category.CategoryId).ToList();
        flavours = await ProductRepo.GetFlavours();
    }

    private string GetImageSource(byte[] imageData, string? FilePath)
    {
        if (imageData == null || imageData.Length == 0)
            return FilePath.Replace("\\", "/");  // fallback image

        var base64 = Convert.ToBase64String(imageData);
        return $"data:image/jpeg;base64,{base64}";
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/Product");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initMainJs");
        }
    }
}
