@page "/ProductEdit/{ProductId:int?}"
@using CakeByHtoo.Models
@using Microsoft.AspNetCore.Components.Forms
@inject Interfaces.IProduct ProductRepo
@inject NavigationManager Navigation

<!-- Toast Alert -->
<div class="toast-container">
    @if (showToast)
    {
        <div class="toast @toastType show">
            @toastMessage
            <button type="button" class="btn-close" @onclick="HideToast">&times;</button>
        </div>
    }
</div>

<section class="wishlist spad">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <div class="wishlist__cart__table">


                    <h4>@(ProductId == 0 ? "Add New Catalog" : "Edit Catalog")</h4>
<hr />

@if (editProduct == null)
{
    <p>Loading...</p>
}
else
{
    <EditForm Model="editProduct" OnValidSubmit="SaveProduct">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Name</label>
            <InputText @bind-Value="editProduct.Name" class="form-control" />
        </div>

      <div class="mb-3">
    <label>Category</label>
                                <select class="form-control" @bind="CategoryId">
                                    <option value="">-- Select Category --</option>
                                    @foreach (var cat in categories)
                                    {
                                        <option value="@cat.CategoryId">@cat.Name</option>
                                    }
                                </select>

</div>

<div class="table-responsive" style="overflow-x:auto; max-width:100%;">
    <table class="table table-striped table-sm" style="min-width:800px; table-layout: fixed;">
        <thead>
            <tr>
                <th>Flavour / Size</th>
                @foreach (var size in filteredSizes)
                {
                    @if (size.CategoryId == 1)
                    {
                        <th>@($"{size.Size}\"")</th>
                    }
                    else if (size.CategoryId == 2)
                    {
                        <th>@($"{size.Size} peoples")</th>
                    }
                    else
                    {
                        <th>@($"{size.Size}")</th>
                    }
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var flavour in flavours)
            {
                <tr>
                    <td>@flavour.Name</td>
                    @foreach (var size in filteredSizes)
                    {
                        var priceObj = editProduct.ProductPrices
                            .FirstOrDefault(pp => pp.ProductSizeId == size.ProductSizeId && pp.FlavourId == flavour.FlavourId);

                        if (priceObj == null)
                        {
                            priceObj = new ProductPrice
                            {
                                ProductSizeId = size.ProductSizeId,
                                FlavourId = flavour.FlavourId,
                                UnitPrice = 0
                            };
                            editProduct.ProductPrices.Add(priceObj);
                        }

                        <td>
                            <InputNumber @bind-Value="priceObj.UnitPrice" class="form-control" style="width:100%" />
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>



        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
    </EditForm>
}
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    /* Modal */
    .modal {
        display: none;
        background-color: rgba(0,0,0,0.5);
        transition: opacity 0.3s ease;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }

        .modal.show.d-block {
            display: block;
            animation: fadeIn 0.3s;
        }

    .modal-dialog.modal-center {
        position: sticky;
        top: 10%;
        left: 30%;
        align-content: center;
        max-width: 550px;
        width: 100%;
    }

    .modal-content {
        background-color: #ffffff;
        /* border-radius: 15px;
                        padding: 1rem; */
    }

    /* Toast */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1055;
    }

    .toast {
        padding: 14px 22px;
        border-radius: 12px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-width: 220px;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

    .toast-success {
        background: #28a745;
    }

    .toast-waming {
        background: #ffc107;
    }

    .toast-danger {
        background: #dc3545;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 18px;
        color: white;
        cursor: pointer;
    }

    /* Category Chips */
    .category-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .chip {
        padding: 8px 18px;
        border-radius: 50px;
        border: 1px solid #ccc;
        background-color: #f9f9f9;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.25s ease;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

        .chip:hover {
            background-color: #e9ecef;
            transform: translateY(-2px);
        }

        .chip.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }

</style>
@code {
    [Parameter] public int? ProductId { get; set; } = 0;

    private Product editProduct;
    private List<Category> categories;
    private List<ProductSize> sizes;
    private List<Flavour> flavours;

    private bool showToast = false;
    private string toastMessage;
    private string toastType;
    private int _categoryId;
    private int CategoryId
    {
        get => editProduct.CategoryId;
        set
        {
            editProduct.CategoryId = value;
            FilterSizesByCategory();
        }
    }

    private List<ProductSize> filteredSizes = new();

    protected override async Task OnInitializedAsync()
    {
        categories = await ProductRepo.GetCategories();
        sizes = await ProductRepo.GetProductSizes();
        flavours = await ProductRepo.GetFlavours();

        if (ProductId.HasValue && ProductId.Value > 0)
        {
            var p = (await ProductRepo.GetAllProducts()).FirstOrDefault(x => x.ProductId == ProductId.Value);
            if (p != null)
            {
                editProduct = new Product
                    {
                        ProductId = p.ProductId,
                        Name = p.Name,
                        CategoryId = p.CategoryId,
                        ProductPrices = p.ProductPrices.Select(pp => new ProductPrice
                        {
                            ProductPriceId = pp.ProductPriceId,
                            ProductId = pp.ProductId,
                            ProductSizeId = pp.ProductSizeId,
                            FlavourId = pp.FlavourId,
                            UnitPrice = pp.UnitPrice
                        }).ToList()
                    };
            }
        }

        if (editProduct == null)
            editProduct = new Product { ProductPrices = new List<ProductPrice>() };

        FilterSizesByCategory();
    }

    private void OnCategoryChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int catId))
        {
            editProduct.CategoryId = catId;
            FilterSizesByCategory();
        }
    }

    private void FilterSizesByCategory()
    {
        if (editProduct.CategoryId > 0)
            filteredSizes = sizes.Where(s => s.CategoryId == editProduct.CategoryId).ToList();
        else
            filteredSizes = new List<ProductSize>();
    }


    private async Task OnImageSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        using var stream = file.OpenReadStream(10 * 1024 * 1024); // 10 MB max
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        var originalBytes = ms.ToArray();

      
        StateHasChanged();
    }

 

    async Task SaveProduct()
    {
        if (editProduct.ProductId == 0)
        {
            await ProductRepo.AddProduct(editProduct);
            ShowToast("Added successfully", "toast-success");
        }
        else
        {
            await ProductRepo.UpdateProduct(editProduct);
            ShowToast("Updated successfully", "toast-success");
        }
       
    }
    private void ShowToast(string message, string type)
    {
        toastMessage = message;
        toastType = type;
        showToast = true;
        StateHasChanged();
        _ = Task.Delay(1000).ContinueWith(_ =>
        {
            showToast = false;
            InvokeAsync(StateHasChanged);
            Navigation.NavigateTo("/Product");
        });
    }
    private void HideToast() => showToast = false;

    void CancelEdit() => Navigation.NavigateTo("/Product");
}
