@inject NavigationManager NavManager
@inject IJSRuntime JS
@inject ICart CartRepo
@inject CommonService.CartStateService CartState
@implements IDisposable

<!-- Offcanvas Menu Begin -->
<div class="offcanvas-menu-overlay"></div>

<div class="offcanvas-menu-wrapper">
    <div class="offcanvas__cart">
        <div class="offcanvas__cart__item">
            <a href="/Cart">
                <img src="img/icon/cart.png" alt="">
                <span>@cartItemCount</span>
            </a>
            <div class="cart__price" style="color:hotpink">
                Cart: <span>@cartTotalAmountFormatted</span>&nbsp;MMK
            </div>
        </div>
        <hr>
    </div>
    <div class="offcanvas__logo">
        <a href="/"><img src="img/LOGO.jpg" style="width: 130px;height: 120px;" alt=""></a>
    </div>
    <hr>
    <div id="mobile-menu-wrap"></div>
    <hr>
    <div class="offcanvas__option">
        <ul>
            <li><h6 style="color:hotpink">မင်္ဂလာရှိသော နေ့လေးဖစ်ပါစေ</h6></li>
        </ul>
    </div>
</div>
<!-- Offcanvas Menu End -->
<!-- Header Section Begin -->
<header class="header">
    <div class="header__top">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="header__top__inner">
                        <div class="header__top__left">
                            <ul>
                                <li>
                                    <a href="/"><img src="img/LOGO.jpg" style="width: 60px;height: 50px;" alt=""></a>
                                    <strong style="color:hotpink">မင်္ဂလာရှိသော နေ့လေးဖစ်ပါစေ</strong>
                                </li>
                            </ul>
                        </div>
                        <div class="header__logo">
                            <a href="/"><img src="img/logo.png" alt=""></a>
                        </div>
                        <div class="header__top__right">
                            <div class="header__top__right__cart">
                                <a href="/Cart">
                                    <img src="img/icon/cart.png" alt="">
                                    <span>@cartItemCount</span>
                                </a>
                                <div class="cart__price" style="color:hotpink">
                                    Cart: <span>@cartTotalAmountFormatted</span>&nbsp;MMK
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="canvas__open"><i class="fa fa-bars"></i></div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <nav class="header__menu mobile-menu">
                    <ul>
                        <li class="@GetActiveClass("/")"><a href="/" @onclick="CloseSidebar">Home</a></li>
                        <li class="@GetActiveClass("/OrderList")"><a href="/OrderList" @onclick="CloseSidebar">Order Lists</a></li>
                        <li class="@GetActiveClass("/Report")"><a href="/Report" @onclick="CloseSidebar">Report</a></li>
                        <li class="@GetActiveClass("/ProductItemDesignonlyshow")"><a href="/ProductItemDesignonlyshow" @onclick="CloseSidebar">Product</a></li>
                        <li>
                            <a href="#">Management</a>
                            <ul class="dropdown">
                               @*  <li class="@GetActiveClass("/ProductItemDesignonlyshow")"><a href="/ProductItemDesignonlyshow" @onclick="CloseSidebar">Product-Item Lists</a></li> *@
                                <li class="@GetActiveClass("/Product")"><a href="/Product" @onclick="CloseSidebar">Catalog/Prices Lists</a></li>
                                <li class="@GetActiveClass("/Flavour")"><a href="/Flavour" @onclick="CloseSidebar">Flavour Lists</a></li>
                                <li class="@GetActiveClass("/ProductSize")"><a href="/ProductSize" @onclick="CloseSidebar">Sizes Lists</a></li>
                                <li class="@GetActiveClass("/Category")"><a href="/Category" @onclick="CloseSidebar">Category Lists</a></li>
                            </ul>
                        </li>
                        <li class="@GetActiveClass("/UserGuide")"><a href="/UserGuide" @onclick="CloseSidebar">UserGuide</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</header>
<!-- Header Section End -->
@code {
    private int cartItemCount = 0;
    private string cartTotalAmountFormatted = "0.00";

    protected override async Task OnInitializedAsync()
    {
        CartState.OnChange += CartChanged;
        NavManager.LocationChanged += (_, __) => CloseSidebar(); // auto close sidebar on navigation
        await LoadCartSummary();
    }

    private async Task LoadCartSummary()
    {
        var cartItems = CartState.CartItems;
        cartItemCount = cartItems?.Sum(ci => ci.Quantity) ?? 0;
        var totalAmount = cartItems?.Sum(ci => ci.SubTotal) ?? 0m;

        if (cartItemCount == 0)
        {
            var count = await CartRepo.GetAllCarts();
            totalAmount = count?.Sum(ci => ci.SubTotal) ?? 0m;
            cartItemCount = count?.Sum(ci => ci.Quantity) ?? 0;
        }

        cartTotalAmountFormatted = $"{totalAmount:N2}";
        await InvokeAsync(StateHasChanged);
    }

    private async void CartChanged()
    {
        await LoadCartSummary();
    }

    private async void CloseSidebar()
    {
        await JS.InvokeVoidAsync("closeOffcanvasMenu");
    }

    public void Dispose()
    {
        CartState.OnChange -= CartChanged;
        NavManager.LocationChanged -= (_, __) => CloseSidebar();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initMainJs");
        }
    }

    private string GetActiveClass(string href)
    {
        var currentUri = NavManager.Uri.TrimEnd('/').ToLower();
        var targetUri = NavManager.BaseUri.TrimEnd('/') + href.TrimStart('/');
        return currentUri == targetUri.ToLower() ? "active" : "";
    }
}
